<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Invertebrate COI 5P DNA Sequence Comparison and Protein Extraction</title>
<link rel="icon" type="image/png" href="favicon2.png">
     <link rel="apple-touch-icon" href="favicon2.png">

<script src="https://cdn.tailwindcss.com"></script>
<script>
  document.addEventListener('alpine:init', () => {

    // ── CODON TABLE 5 ──────────────────────────────────────────────────────
    const AAS   = "FFLLSSSSYY**CCWWLLLLPPPPHHQQRRRRIIMMTTTTNNKKSSSSVVVVAAAADDEEGGGG";
    const BASE1 = "TTTTTTTTTTTTTTTTCCCCCCCCCCCCCCCCAAAAAAAAAAAAAAAAGGGGGGGGGGGGGGGG";
    const BASE2 = "TTTTCCCCAAAAGGGGTTTTCCCCAAAAGGGGTTTTCCCCAAAAGGGGTTTTCCCCAAAAGGGG";
    const BASE3 = "TCAGTCAGTCAGTCAGTCAGTCAGTCAGTCAGTCAGTCAGTCAGTCAGTCAGTCAGTCAGTCAG";
    const CODON_MAP = {};
    for (let i = 0; i < 64; i++) CODON_MAP[BASE1[i]+BASE2[i]+BASE3[i]] = AAS[i];

    function translateFrame(dna, frame) {
      const seq = dna.replace(/[\s-]/g,'').toUpperCase().replace(/U/g,'T').slice(frame);
      let out = '';
      for (let i = 0; i <= seq.length - 3; i += 3) {
        const c = seq.slice(i, i+3);
        out += c.includes('N') ? '?' : (CODON_MAP[c] || '?');
      }
      return out;
    }

    function esc(s) {
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function reverseComplementSimple(seq) {
      const m = {A:'T',T:'A',C:'G',G:'C',N:'N'};
      return seq.split('').reverse().map(b => m[b]||b).join('');
    }

    // ── SEMI-GLOBAL OVERLAP ALIGNER (gap-penalty aware) ─────────────────────
    // Correct algorithm for overlapping Sanger reads: free end-gaps, penalised
    // internal gaps. Handles small indels that confused the old shift-only method.
    function alignOverlap(s1, s2) {
      const MATCH = 2, MISMATCH = -1, GAP = -2;
      const m = s1.length, n = s2.length;

      // Cap for browser performance on very long inputs
      if (m > 1400 || n > 1400) return alignOverlapFast(s1, s2);

      // DP matrix (semi-global: first row/col initialised to 0 for free leading gaps)
      const H   = Array.from({length: m+1}, () => new Int32Array(n+1));
      const ptr = Array.from({length: m+1}, () => new Uint8Array(n+1)); // 1=diag,2=up,3=left

      for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
          const diag = H[i-1][j-1] + (s1[i-1] === s2[j-1] ? MATCH : MISMATCH);
          const up   = H[i-1][j] + GAP;
          const left = H[i][j-1] + GAP;
          if (diag >= up && diag >= left) { H[i][j] = diag; ptr[i][j] = 1; }
          else if (up >= left)            { H[i][j] = up;   ptr[i][j] = 2; }
          else                            { H[i][j] = left;  ptr[i][j] = 3; }
        }
      }

      // Best end position (free trailing gaps → scan last row and last col)
      let best = -Infinity, ei = m, ej = n;
      for (let j = 0; j <= n; j++) if (H[m][j] > best) { best = H[m][j]; ei = m; ej = j; }
      for (let i = 0; i <= m; i++) if (H[i][n] > best) { best = H[i][n]; ei = i; ej = n; }

      // Traceback
      let al1='', al2='', mLine='';
      let i = ei, j = ej;
      while (i > 0 && j > 0) {
        const p = ptr[i][j];
        if (p===1) { al1=s1[i-1]+al1; al2=s2[j-1]+al2; mLine=(s1[i-1]===s2[j-1]?'|':'.')+mLine; i--; j--; }
        else if (p===2) { al1=s1[i-1]+al1; al2='-'+al2; mLine=' '+mLine; i--; }
        else            { al1='-'+al1; al2=s2[j-1]+al2; mLine=' '+mLine; j--; }
      }

      // Flanking (unaligned) tails
      const lead1 = s1.slice(0,i), lead2 = s2.slice(0,j);
      const ll = Math.max(lead1.length, lead2.length);
      const trail1 = s1.slice(ei), trail2 = s2.slice(ej);
      const tl = Math.max(trail1.length, trail2.length);

      const full1 = lead1.padStart(ll) + al1 + trail1.padEnd(tl);
      const full2 = lead2.padStart(ll) + al2 + trail2.padEnd(tl);
      const fullM = ' '.repeat(ll) + mLine + ' '.repeat(tl);

      const matches  = (mLine.match(/\|/g)||[]).length;
      const compared = mLine.replace(/ /g,'').length;

      return {
        a1: full1, a2: full2, matchLine: fullM,
        ov1: al1.replace(/^-+|-+$/g,''),
        ov2: al2.replace(/^-+|-+$/g,''),
        alSeq1: al1, alSeq2: al2,
        identity: compared>0 ? ((matches/compared)*100).toFixed(1) : '0.0',
        frac: `${matches}/${compared}`,
        ovLen: al1.length,
        direction: 'Forward'
      };
    }

    // Fallback for very long sequences: original shift-based method
    function alignOverlapFast(s1, s2) {
      let bestShift=0, maxMatches=-1;
      for (let shift=-(s2.length-10); shift<s1.length-10; shift++) {
        let matches=0, ov=0;
        const st=Math.max(0,shift), en=Math.min(s1.length, s2.length+shift);
        for (let i=st; i<en; i++) { ov++; if (s1[i]===s2[i-shift]) matches++; }
        if (ov>=20 && matches>maxMatches) { maxMatches=matches; bestShift=shift; }
      }
      const shift=bestShift;
      const pad1=Math.max(0,-shift), pad2=Math.max(0,shift);
      const a1=' '.repeat(pad1)+s1, a2=' '.repeat(pad2)+s2;
      const maxL=Math.max(a1.length,a2.length);
      let matchLine='', perfect=0, totalOv=0;
      for (let j=0;j<maxL;j++) {
        const c1=j<a1.length?a1[j]:' ', c2=j<a2.length?a2[j]:' ';
        if (c1!==' '&&c2!==' ') { totalOv++; if(c1===c2){matchLine+='|';perfect++;}else matchLine+='.'; } else matchLine+=' ';
      }
      const ovStart=Math.max(pad1,pad2), ovEnd=Math.min(s1.length+pad1,s2.length+pad2);
      return { a1, a2, matchLine, ov1:a1.slice(ovStart,ovEnd).trim(), ov2:a2.slice(ovStart,ovEnd).trim(),
               alSeq1:a1.slice(ovStart,ovEnd).trim(), alSeq2:a2.slice(ovStart,ovEnd).trim(),
               identity:totalOv>0?((perfect/totalOv)*100).toFixed(1):'0.0',
               frac:`${perfect}/${totalOv}`, ovLen:ovEnd-ovStart, direction:'Forward' };
    }

    // ── KIMURA 2-PARAMETER (K2P) MODEL ──────────────────────────────────────
    // Hebert et al. (2003) standard for DNA barcoding. Weights transitions and
    // transversions differently — the industry standard used by BOLD Systems.
    function k2pDistance(al1, al2) {
      const purines = new Set(['A','G']);
      let P=0, Q=0, N=0; // transitions, transversions, comparable sites
      const len = Math.min(al1.length, al2.length);
      for (let i=0; i<len; i++) {
        const a=al1[i], b=al2[i];
        if (a==='-'||b==='-'||a==='N'||b==='N'||a===' '||b===' ') continue;
        N++;
        if (a===b) continue;
        if (purines.has(a)===purines.has(b)) P++; // same nucleotide class = transition
        else Q++;                                   // different class = transversion
      }
      if (N < 10) return null;
      const p=P/N, q=Q/N;
      const w1=1-2*p-q, w2=1-2*q;
      if (w1<=0||w2<=0) return { d:null, P, Q, N, p, q, saturated:true };
      const d = -0.5*Math.log(w1) - 0.25*Math.log(w2);
      return { d, P, Q, N, p, q, saturated:false };
    }

    // ── TAXONOMIC INTERPRETATION (Hebert et al. 2003 thresholds) ────────────
    function interpretK2P(k2p) {
      if (!k2p || k2p.saturated) return {
        level:'Saturated / Uncertain',
        colorBg:'bg-slate-100', colorBorder:'border-slate-300', colorText:'text-slate-700',
        icon:'fa-circle-question',
        desc:'The K2P model is saturated at this divergence level — multiple substitutions per site make the estimate unreliable. Sequences are from clearly different higher taxa.'
      };
      const d = k2p.d;
      const pct = (d*100).toFixed(2);
      if (d < 0.02) return {
        level:'Likely Same Species',
        colorBg:'bg-green-50', colorBorder:'border-green-300', colorText:'text-green-800',
        icon:'fa-circle-check',
        desc:`K2P distance ${pct}% is below the 2% intraspecific threshold (Hebert et al. 2003). These sequences very likely represent the same species or population.`
      };
      if (d < 0.05) return {
        level:'Same Species / Sister Species',
        colorBg:'bg-emerald-50', colorBorder:'border-emerald-300', colorText:'text-emerald-800',
        icon:'fa-angles-up',
        desc:`K2P distance ${pct}% is low but above 2%. Could be cryptic species, sister species, or intraspecific variation with incomplete lineage sorting.`
      };
      if (d < 0.15) return {
        level:'Same Genus — Different Species',
        colorBg:'bg-blue-50', colorBorder:'border-blue-300', colorText:'text-blue-800',
        icon:'fa-layer-group',
        desc:`K2P distance ${pct}% is in the interspecific range (5–15%). Sequences are likely from different species within the same genus.`
      };
      if (d < 0.25) return {
        level:'Same Family — Different Genera',
        colorBg:'bg-amber-50', colorBorder:'border-amber-300', colorText:'text-amber-800',
        icon:'fa-sitemap',
        desc:`K2P distance ${pct}% (15–25%) is typical of species in the same family but different genera.`
      };
      return {
        level:'Distant — Different Families or Higher',
        colorBg:'bg-red-50', colorBorder:'border-red-300', colorText:'text-red-800',
        icon:'fa-circle-xmark',
        desc:`K2P distance ${pct}% exceeds typical family-level divergence. These sequences are from distantly related taxa.`
      };
    }

    // ── ALIGNER ────────────────────────────────────────────────────────────
    Alpine.data('aligner', () => ({
      fragA: '', fragB: '',
      result: null,
      running: false,
      copyStates: { ov1: false, ov2: false },

      run() {
        if (!this.fragA.trim() || !this.fragB.trim()) return;
        this.running = true;
        setTimeout(() => {
          const s1     = this.fragA.replace(/[-\s]/g,'').toUpperCase();
          const s2orig = this.fragB.replace(/[-\s]/g,'').toUpperCase();
          const s2rc   = reverseComplementSimple(s2orig);

          // Run semi-global overlap alignment in both orientations; pick better identity
          const fwdRes = alignOverlap(s1, s2orig);
          const revRes = alignOverlap(s1, s2rc);
          const useFwd = parseFloat(fwdRes.identity) >= parseFloat(revRes.identity);
          const res    = useFwd ? fwdRes : { ...revRes, direction: 'Reverse Complement' };

          // K2P from the aligned overlap
          const k2p    = k2pDistance(res.alSeq1, res.alSeq2);
          const interp = interpretK2P(k2p);

          this.result = {
            ...res,
            direction: useFwd ? 'Forward' : 'Reverse Complement',
            k2p,
            interp,
          };
          this.running = false;
        }, 30);
      },

      copyText(key, text) {
        navigator.clipboard.writeText(text).then(() => {
          this.copyStates[key] = true;
          setTimeout(() => this.copyStates[key] = false, 1800);
        });
      }
    }));

    // ── TRANSLATOR ─────────────────────────────────────────────────────────
    Alpine.data('translator', () => ({
      seqs: [{ id: 1, val: '' }],
      nextId: 2,
      results: [],
      frameCopyStates: {},

      addSeq()      { this.seqs.push({ id: this.nextId++, val: '' }); },
      removeSeq(id) { this.seqs = this.seqs.filter(s => s.id !== id); },

      translate() {
        this.results = this.seqs
          .filter(s => s.val.trim())
          .map((s, idx) => ({
            index: idx+1,
            frames: [0,1,2].map(f => {
              const prot  = translateFrame(s.val, f);
              const stops = (prot.match(/\*/g)||[]).length;
              // Internal stop = stop codon before the final 3 residues of the protein.
              // A single terminal stop is normal; stops mid-sequence = frameshift or pseudogene.
              const internalStops = (prot.slice(0, -3).match(/\*/g)||[]).length;
              return { frame:f+1, prot, stops, internalStops };
            })
          }));
      },

      copyFrame(seqIdx, frame, text) {
        const key = `${seqIdx}-${frame}`;
        navigator.clipboard.writeText(text).then(() => {
          this.frameCopyStates = {...this.frameCopyStates, [key]: true};
          setTimeout(() => {
            this.frameCopyStates = {...this.frameCopyStates, [key]: false};
          }, 1800);
        });
      },

      renderProt(prot) {
        return prot.split('').map(aa =>
          aa==='*' ? `<span class="text-red-500 font-bold">*</span>` : esc(aa)
        ).join('');
      }
    }));

    // ── COMPARATOR ─────────────────────────────────────────────────────────
    Alpine.data('comparator', () => ({
      p1: '', p2: '',
      result: null,

      compare() {
        const s1 = this.p1.trim().toUpperCase();
        const s2 = this.p2.trim().toUpperCase();
        if (!s1||!s2) return;
        const len = Math.min(s1.length, s2.length);
        let matches=0, mismatches=0, ambiguous=0, h1='', h2='';

        for (let i=0; i<len; i++) {
          const c1=s1[i], c2=s2[i];
          if (c1==='?'||c2==='?') {
            h1+=`<span class="text-slate-400">${esc(c1)}</span>`;
            h2+=`<span class="text-slate-400">${esc(c2)}</span>`;
            ambiguous++;
          } else if (c1===c2) {
            h1+=esc(c1); h2+=esc(c2); matches++;
          } else {
            h1+=`<span class="bg-amber-100 text-amber-700 rounded px-px font-semibold">${esc(c1)}</span>`;
            h2+=`<span class="bg-amber-100 text-amber-700 rounded px-px font-semibold">${esc(c2)}</span>`;
            mismatches++;
          }
        }
        if (s1.length>len) h1+=`<span class="text-slate-300">${esc(s1.slice(len))}</span>`;
        if (s2.length>len) h2+=`<span class="text-slate-300">${esc(s2.slice(len))}</span>`;

        const tv=matches+mismatches;
        this.result = {
          h1, h2, matches, mismatches, ambiguous,
          pct: tv>0 ? ((matches/tv)*100).toFixed(2) : '0.00',
          len1: s1.length, len2: s2.length
        };
      }
    }));

    // ── STRAND COUNTER ─────────────────────────────────────────────────────
    Alpine.data('counter', () => ({
      seqs: [{ id: 1, label: 'Strand 1', val: '' }],
      nextId: 2,

      addSeq() { this.seqs.push({ id: this.nextId++, label: 'Strand ' + this.nextId, val: '' }); },
      removeSeq(id) { this.seqs = this.seqs.filter(s => s.id !== id); },

      stats(val) {
        const raw   = val;
        const clean = val.replace(/[\s\-]/g, '').toUpperCase().replace(/U/g, 'T');
        const a = (clean.match(/A/g)||[]).length;
        const t = (clean.match(/T/g)||[]).length;
        const c = (clean.match(/C/g)||[]).length;
        const g = (clean.match(/G/g)||[]).length;
        const n = (clean.match(/N/g)||[]).length;
        const other = clean.length - a - t - c - g - n;
        const atgc  = a + t + c + g;
        const gcNum = atgc > 0 ? ((g + c) / atgc) * 100 : null;
        const gc    = gcNum !== null ? gcNum.toFixed(1) : '—';
        const codons = Math.floor(clean.length / 3);
        // GC Bias: invertebrate mitochondrial DNA is typically AT-rich (~35% GC)
        let gcBias = null;
        if (gcNum !== null) {
          if      (gcNum < 25)             gcBias = { label:'Very AT-rich',  note:'Extremely low GC (<25%) — may indicate NUMT or non-standard region.', color:'bg-orange-50 border-orange-200 text-orange-800' };
          else if (gcNum < 32)             gcBias = { label:'AT-rich',       note:'GC content is low (25–32%), consistent with invertebrate mitochondrial DNA.', color:'bg-green-50 border-green-200 text-green-800' };
          else if (gcNum <= 42)            gcBias = { label:'Typical',       note:'GC content is in the normal range (32–42%) for invertebrate mitochondrial DNA.', color:'bg-green-50 border-green-200 text-green-800' };
          else if (gcNum <= 55)            gcBias = { label:'GC-elevated',   note:'GC content (42–55%) is higher than typical for invertebrate mt DNA. May be nuclear or unusual sequence.', color:'bg-amber-50 border-amber-200 text-amber-800' };
          else                             gcBias = { label:'Highly GC-rich',note:'GC content >55% is atypical for invertebrate mt DNA. Likely nuclear, bacterial contamination, or GC-biased gene.', color:'bg-red-50 border-red-200 text-red-800' };
        }
        return { raw: raw.length, clean: clean.length, a, t, c, g, n, other, gc, codons, gcBias };
      }
    }));

  });
</script>
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  [x-cloak] { display: none !important; }
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: #f1f5f9; }
  ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  .seq-mono {
    font-family: 'Courier New', monospace;
    font-size: 12px;
    white-space: pre;
    letter-spacing: 0.04em;
  }
  .tab-active   { border-bottom: 2px solid #2563eb; color: #1d4ed8 !important; background: #eff6ff; }
  .tab-inactive { border-bottom: 2px solid transparent; }
  .tab-inactive:hover { color: #334155; background: #f8fafc; }
</style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen font-sans pb-24">

<!-- ── HEADER ──────────────────────────────────────────────────────────────── -->
<header class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
  <div class="max-w-5xl mx-auto px-4 py-3 flex flex-wrap justify-between items-center gap-3">
    <div class="flex items-center gap-3">
      <div class="bg-blue-100 p-2 rounded-lg">
        <i class="fa-solid fa-dna text-blue-600 text-xl"></i>
      </div>
      <div>
        <h1 class="text-lg font-bold text-slate-900 leading-tight">Invertebrate DNA Sequencer</h1>
        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">DNA · Protein Analysis</p>
      </div>
    </div>
    <p class="text-[10px] text-slate-400 font-mono tracking-wider hidden sm:block">
      The Invertebrate Mitochondrial Code (transl_table=5)
    </p>
  </div>

  <!-- Tab row -->
  <div class="max-w-5xl mx-auto px-4 flex gap-1 flex-wrap">
    <button onclick="showTab('align')" id="tab-align"
      class="tab-active text-slate-500 px-5 py-3 text-sm font-semibold rounded-t-lg transition-all">
      <i class="fa-solid fa-arrows-left-right mr-2 opacity-70"></i>Fragment Aligner
    </button>
    <button onclick="showTab('translate')" id="tab-translate"
      class="tab-inactive text-slate-500 px-5 py-3 text-sm font-semibold rounded-t-lg transition-all">
      <i class="fa-solid fa-arrow-right-to-bracket mr-2 opacity-70"></i>DNA → Amino Acid
    </button>
    <button onclick="showTab('compare')" id="tab-compare"
      class="tab-inactive text-slate-500 px-5 py-3 text-sm font-semibold rounded-t-lg transition-all">
      <i class="fa-solid fa-code-compare mr-2 opacity-70"></i>Protein Comparator
    </button>
    <button onclick="showTab('counter')" id="tab-counter"
      class="tab-inactive text-slate-500 px-5 py-3 text-sm font-semibold rounded-t-lg transition-all">
      <i class="fa-solid fa-ruler-horizontal mr-2 opacity-70"></i>Strand Length
    </button>
  </div>
</header>

<!-- ── MAIN ────────────────────────────────────────────────────────────────── -->
<main class="max-w-5xl mx-auto px-4 py-8 space-y-5">

  <!-- ══ ALIGNER PANEL ══════════════════════════════════════════════════════ -->
  <div id="panel-align" x-data="aligner">

    <p class="text-sm text-slate-500 leading-relaxed mb-6">
      Paste two DNA fragments. The tool slides Fragment 2 — and its reverse complement — across Fragment 1
      to find the highest-identity overlap. Dashes and whitespace are stripped automatically.
    </p>

    <div class="grid md:grid-cols-2 gap-4 mb-4">
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
        <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">
          <i class="fa-solid fa-1 mr-1 text-blue-400"></i>Fragment 1
        </label>
        <textarea x-model="fragA" rows="5" placeholder="ATCGATCG…"
          class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg text-xs font-mono focus:ring-2 focus:ring-blue-400 outline-none resize-none transition-all"></textarea>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
        <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">
          <i class="fa-solid fa-2 mr-1 text-blue-400"></i>Fragment 2
        </label>
        <textarea x-model="fragB" rows="5" placeholder="ATCGATCG…"
          class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg text-xs font-mono focus:ring-2 focus:ring-blue-400 outline-none resize-none transition-all"></textarea>
      </div>
    </div>

    <button @click="run()"
      :disabled="running || !fragA.trim() || !fragB.trim()"
      :class="(running||!fragA.trim()||!fragB.trim()) ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-900'"
      class="bg-slate-800 text-white px-6 py-2.5 rounded-lg text-sm font-bold shadow-sm transition-all flex items-center gap-2">
      <i class="fa-solid fa-play text-xs"></i>
      <span x-text="running ? 'Aligning…' : 'Run Alignment'"></span>
    </button>

    <!-- Results -->
    <template x-if="result">
      <div class="space-y-4 mt-6">

        <!-- Stats -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
          <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Alignment Summary</p>
          <div class="flex flex-wrap gap-6">
            <div>
              <p class="text-[10px] text-slate-400 uppercase tracking-widest mb-1">Direction</p>
              <p class="font-bold text-slate-700 font-mono text-sm" x-text="result.direction"></p>
            </div>
            <div>
              <p class="text-[10px] text-slate-400 uppercase tracking-widest mb-1">DNA Identity</p>
              <p class="font-bold text-green-600 font-mono text-sm">
                <span x-text="result.frac"></span>
                <span class="text-slate-400 font-normal"> (<span x-text="result.identity"></span>%)</span>
              </p>
            </div>
            <div>
              <p class="text-[10px] text-slate-400 uppercase tracking-widest mb-1">Overlap Length</p>
              <p class="font-bold text-slate-700 font-mono text-sm"><span x-text="result.ovLen"></span> bp</p>
            </div>
            <!-- K2P stats (only when available) -->
            <template x-if="result.k2p && !result.k2p.saturated && result.k2p.d !== null">
              <div>
                <p class="text-[10px] text-slate-400 uppercase tracking-widest mb-1">K2P Distance</p>
                <p class="font-bold text-blue-600 font-mono text-sm" x-text="(result.k2p.d * 100).toFixed(2) + '%'"></p>
              </div>
            </template>
            <template x-if="result.k2p && !result.k2p.saturated && result.k2p.d !== null">
              <div>
                <p class="text-[10px] text-slate-400 uppercase tracking-widest mb-1">Transitions / Tv</p>
                <p class="font-bold text-slate-600 font-mono text-sm"><span x-text="result.k2p.P"></span> ts / <span x-text="result.k2p.Q"></span> tv</p>
              </div>
            </template>
          </div>
        </div>

        <!-- Taxonomic Interpretation (Hebert et al. 2003) -->
        <template x-if="result.interp">
          <div class="rounded-xl border p-5" :class="[result.interp.colorBg, result.interp.colorBorder]">
            <div class="flex items-start gap-3">
              <div class="mt-0.5 shrink-0">
                <i class="fa-solid text-lg" :class="[result.interp.icon, result.interp.colorText]"></i>
              </div>
              <div>
                <div class="flex items-center gap-2 mb-1 flex-wrap">
                  <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Taxonomic Interpretation</p>
                  <span class="text-[10px] font-black uppercase tracking-widest px-2 py-0.5 rounded-full text-white"
                    :class="{'bg-green-600':result.interp.colorBg.includes('green'), 'bg-emerald-600':result.interp.colorBg.includes('emerald'), 'bg-blue-600':result.interp.colorBg.includes('blue'), 'bg-amber-500':result.interp.colorBg.includes('amber'), 'bg-red-600':result.interp.colorBg.includes('red'), 'bg-slate-400':result.interp.colorBg.includes('slate')}">
                    Hebert et al. 2003
                  </span>
                </div>
                <p class="font-bold text-base" :class="result.interp.colorText" x-text="result.interp.level"></p>
                <p class="text-xs text-slate-600 mt-1" x-text="result.interp.desc"></p>
              </div>
            </div>
          </div>
        </template>

        <!-- Full alignment — single box, no copy buttons -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
          <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Full Alignment</p>
          <div class="bg-slate-50 rounded-lg border border-slate-200 p-4 overflow-x-auto">
            <div class="seq-mono text-slate-700 mb-1">
              <span class="text-slate-400 select-none inline-block w-16">FRAG 1</span><span x-text="result.a1"></span>
            </div>
            <div class="seq-mono text-blue-400 mb-1">
              <span class="text-slate-300 select-none inline-block w-16">MATCH</span><span x-text="result.matchLine"></span>
            </div>
            <div class="seq-mono text-slate-700">
              <span class="text-slate-400 select-none inline-block w-16">FRAG 2</span><span x-text="result.a2"></span>
            </div>
          </div>
        </div>

        <!-- Overlap — two cards with copy buttons, no match line -->
        <div class="grid md:grid-cols-2 gap-4">
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
            <div class="flex justify-between items-center mb-3">
              <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Overlap — Fragment 1</p>
              <button @click="copyText('ov1', result.ov1)"
                :class="copyStates.ov1 ? 'bg-green-600 hover:bg-green-700' : 'bg-slate-800 hover:bg-slate-900'"
                class="text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-all flex items-center gap-1.5 shadow-sm">
                <i :class="copyStates.ov1 ? 'fa-solid fa-circle-check' : 'fa-solid fa-copy'"></i>
                <span x-text="copyStates.ov1 ? 'Copied!' : 'Copy'"></span>
              </button>
            </div>
            <div class="bg-slate-50 rounded-lg border border-slate-200 p-3 overflow-x-auto">
              <div class="seq-mono text-slate-700" x-text="result.ov1"></div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
            <div class="flex justify-between items-center mb-3">
              <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Overlap — Fragment 2</p>
              <button @click="copyText('ov2', result.ov2)"
                :class="copyStates.ov2 ? 'bg-green-600 hover:bg-green-700' : 'bg-slate-800 hover:bg-slate-900'"
                class="text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-all flex items-center gap-1.5 shadow-sm">
                <i :class="copyStates.ov2 ? 'fa-solid fa-circle-check' : 'fa-solid fa-copy'"></i>
                <span x-text="copyStates.ov2 ? 'Copied!' : 'Copy'"></span>
              </button>
            </div>
            <div class="bg-slate-50 rounded-lg border border-slate-200 p-3 overflow-x-auto">
              <div class="seq-mono text-slate-700" x-text="result.ov2"></div>
            </div>
          </div>
        </div>

      </div>
    </template>
  </div><!-- /aligner -->

  <!-- ══ TRANSLATOR PANEL ════════════════════════════════════════════════════ -->
  <div id="panel-translate" class="hidden" x-data="translator">

    <p class="text-sm text-slate-500 leading-relaxed mb-6">
      Translates DNA using <span class="font-semibold text-slate-700">NCBI Genetic Code Table 5</span>
      (Invertebrate Mitochondrial). All three reading frames are shown with stop codon counts.
    </p>

    <div class="space-y-4 mb-4">
      <template x-for="(seq, idx) in seqs" :key="seq.id">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
          <div class="flex justify-between items-center mb-3">
            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
              <i class="fa-solid fa-dna mr-1 text-blue-400"></i>Sequence <span x-text="idx+1"></span>
            </label>
            <button x-show="seqs.length > 1" @click="removeSeq(seq.id)"
              class="text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg p-1.5 transition-all">
              <i class="fa-solid fa-trash-can text-xs"></i>
            </button>
          </div>
          <textarea x-model="seq.val" rows="3" placeholder="ATCGATCG…"
            class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg text-xs font-mono focus:ring-2 focus:ring-blue-400 outline-none resize-none transition-all"></textarea>
        </div>
      </template>
    </div>

    <div class="flex gap-3 mb-6">
      <button @click="translate()"
        :disabled="seqs.every(s => !s.val.trim())"
        :class="seqs.every(s=>!s.val.trim()) ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-900'"
        class="bg-slate-800 text-white px-6 py-2.5 rounded-lg text-sm font-bold shadow-sm transition-all flex items-center gap-2">
        <i class="fa-solid fa-play text-xs"></i>Translate All
      </button>
      <button @click="addSeq()"
        class="bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 px-5 py-2.5 rounded-lg text-sm font-semibold transition-all flex items-center gap-2 shadow-sm">
        <i class="fa-solid fa-plus text-xs"></i>Add Sequence
      </button>
    </div>

    <!-- Results -->
    <div class="space-y-5" x-show="results.length > 0" x-cloak>
      <template x-for="res in results" :key="res.index">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
          <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4">
            <i class="fa-solid fa-dna mr-1 text-blue-400"></i>Sequence <span x-text="res.index"></span>
          </p>
          <div class="space-y-3">
            <template x-for="fr in res.frames" :key="fr.frame">
              <div class="rounded-xl border border-slate-200 overflow-hidden">
                <!-- Frame header -->
                <div class="bg-slate-50 border-b border-slate-200 px-4 py-2.5 flex justify-between items-center">
                  <div class="flex items-center gap-3">
                    <span class="bg-slate-800 text-white text-[10px] font-black px-2.5 py-1 rounded-md tracking-widest">
                      FRAME <span x-text="fr.frame"></span>
                    </span>
                    <span class="text-[10px] font-bold px-2.5 py-1 rounded-full uppercase tracking-wider"
                      :class="{
                        'bg-green-100 text-green-700': fr.stops === 0,
                        'bg-amber-100 text-amber-700': fr.stops > 0 && fr.stops <= 2,
                        'bg-red-100 text-red-600': fr.stops > 2
                      }">
                      <span x-text="fr.stops"></span> stop<span x-text="fr.stops !== 1 ? 's' : ''"></span>
                    </span>
                  </div>
                  <button
                    @click="copyFrame(res.index, fr.frame, fr.prot)"
                    :class="frameCopyStates[res.index+'-'+fr.frame] ? 'bg-green-600 hover:bg-green-700' : 'bg-slate-800 hover:bg-slate-900'"
                    class="text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-all flex items-center gap-1.5 shadow-sm">
                    <i :class="frameCopyStates[res.index+'-'+fr.frame] ? 'fa-solid fa-circle-check' : 'fa-solid fa-copy'"></i>
                    <span x-text="frameCopyStates[res.index+'-'+fr.frame] ? 'Copied!' : 'Copy Frame '+fr.frame"></span>
                  </button>
                </div>
                <!-- Protein sequence -->
                <div class="p-4 overflow-x-auto">
                  <!-- Frameshift / Pseudogene Warning -->
                  <template x-if="fr.internalStops > 0">
                    <div class="flex items-start gap-2 bg-red-50 border border-red-200 rounded-lg px-3 py-2.5 mb-3">
                      <i class="fa-solid fa-triangle-exclamation text-red-500 mt-px shrink-0"></i>
                      <div>
                        <p class="text-xs font-bold text-red-700">⚠ Potential Pseudogene or Frame-shift Detected</p>
                        <p class="text-[11px] text-red-600 mt-0.5">
                          <span x-text="fr.internalStops"></span> internal stop codon<span x-text="fr.internalStops > 1 ? 's' : ''"></span> found before the sequence end.
                          This is characteristic of a NUMT (nuclear mitochondrial DNA insert) or a sequencing frame-shift error.
                          A functional coding gene should have at most one terminal stop codon.
                        </p>
                      </div>
                    </div>
                  </template>
                  <div class="seq-mono text-slate-700 break-all" x-html="renderProt(fr.prot)"></div>
                </div>
              </div>
            </template>
          </div>
        </div>
      </template>
    </div>

  </div><!-- /translator -->

  <!-- ══ COMPARATOR PANEL ════════════════════════════════════════════════════ -->
  <div id="panel-compare" class="hidden" x-data="comparator">

    <p class="text-sm text-slate-500 leading-relaxed mb-6">
      Compare two amino acid sequences position-by-position.
      <span class="font-semibold text-amber-600">Amber highlights</span> mark mismatches;
      extra residues beyond the shorter sequence appear dimmed.
    </p>

    <div class="grid md:grid-cols-2 gap-4 mb-4">
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
        <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">
          <i class="fa-solid fa-p mr-1 text-blue-400"></i>Protein 1
        </label>
        <textarea x-model="p1" rows="4" placeholder="MLLFFNSK…"
          class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg text-xs font-mono focus:ring-2 focus:ring-blue-400 outline-none resize-none transition-all"></textarea>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
        <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">
          <i class="fa-solid fa-p mr-1 text-blue-400"></i>Protein 2
        </label>
        <textarea x-model="p2" rows="4" placeholder="MLLFFNSK…"
          class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg text-xs font-mono focus:ring-2 focus:ring-blue-400 outline-none resize-none transition-all"></textarea>
      </div>
    </div>

    <button @click="compare()"
      :disabled="!p1.trim() || !p2.trim()"
      :class="(!p1.trim()||!p2.trim()) ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-900'"
      class="bg-slate-800 text-white px-6 py-2.5 rounded-lg text-sm font-bold shadow-sm transition-all flex items-center gap-2 mb-6">
      <i class="fa-solid fa-play text-xs"></i>Compare Sequences
    </button>

    <template x-if="result">
      <div class="space-y-4">
        <!-- Stats -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
          <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Comparison Summary</p>
          <div class="flex flex-wrap gap-6">
            <div>
              <p class="text-[10px] text-slate-400 uppercase tracking-widest mb-1">Identity</p>
              <p class="font-bold text-green-600 font-mono text-sm" x-text="result.pct + '%'"></p>
            </div>
            <div>
              <p class="text-[10px] text-slate-400 uppercase tracking-widest mb-1">Matches</p>
              <p class="font-bold text-slate-700 font-mono text-sm" x-text="result.matches"></p>
            </div>
            <div>
              <p class="text-[10px] text-slate-400 uppercase tracking-widest mb-1">Mismatches</p>
              <p class="font-bold text-amber-600 font-mono text-sm" x-text="result.mismatches"></p>
            </div>
            <div>
              <p class="text-[10px] text-slate-400 uppercase tracking-widest mb-1">Ambiguous</p>
              <p class="font-bold text-slate-400 font-mono text-sm" x-text="result.ambiguous"></p>
            </div>
            <div>
              <p class="text-[10px] text-slate-400 uppercase tracking-widest mb-1">Length 1</p>
              <p class="font-bold text-slate-700 font-mono text-sm"><span x-text="result.len1"></span> aa</p>
            </div>
            <div>
              <p class="text-[10px] text-slate-400 uppercase tracking-widest mb-1">Length 2</p>
              <p class="font-bold text-slate-700 font-mono text-sm"><span x-text="result.len2"></span> aa</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
          <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Protein 1</p>
          <div class="bg-slate-50 rounded-lg border border-slate-200 p-4 overflow-x-auto">
            <div class="seq-mono text-slate-700 break-all" x-html="result.h1"></div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
          <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Protein 2</p>
          <div class="bg-slate-50 rounded-lg border border-slate-200 p-4 overflow-x-auto">
            <div class="seq-mono text-slate-700 break-all" x-html="result.h2"></div>
          </div>
        </div>
      </div>
    </template>

  </div><!-- /comparator -->

  <!-- ══ STRAND LENGTH COUNTER PANEL ════════════════════════════════════════ -->
  <div id="panel-counter" class="hidden" x-data="counter">

    <p class="text-sm text-slate-500 leading-relaxed mb-6">
      Paste one or more DNA strands for an instant character count and nucleotide breakdown.
      Dashes and whitespace are stripped for the <span class="font-semibold text-slate-700">clean length</span>.
      GC content is evaluated against typical invertebrate mitochondrial DNA composition. Results update live as you type.
    </p>

    <div class="space-y-5">
      <template x-for="(seq, idx) in seqs" :key="seq.id">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">

          <!-- Card header -->
          <div class="flex justify-between items-center mb-3">
            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
              <i class="fa-solid fa-ruler-horizontal mr-1 text-blue-400"></i>
              Strand <span x-text="idx + 1"></span>
            </label>
            <button x-show="seqs.length > 1" @click="removeSeq(seq.id)"
              class="text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg p-1.5 transition-all">
              <i class="fa-solid fa-trash-can text-xs"></i>
            </button>
          </div>

          <!-- Textarea -->
          <textarea x-model="seq.val" rows="3" placeholder="ATCGATCG…"
            class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg text-xs font-mono focus:ring-2 focus:ring-blue-400 outline-none resize-none transition-all mb-4"></textarea>

          <!-- Live stats — only shown when there's input -->
          <template x-if="seq.val.trim()">
            <div>
              <!-- Primary counts row -->
              <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-3">
                <div class="bg-blue-50 border border-blue-100 rounded-lg p-3 text-center">
                  <p class="text-[10px] font-bold text-blue-400 uppercase tracking-widest mb-1">Clean Length</p>
                  <p class="text-2xl font-black text-blue-700 font-mono" x-text="stats(seq.val).clean"></p>
                  <p class="text-[10px] text-blue-400 mt-0.5">bp (no gaps)</p>
                </div>
                <div class="bg-slate-50 border border-slate-200 rounded-lg p-3 text-center">
                  <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Raw Length</p>
                  <p class="text-2xl font-black text-slate-600 font-mono" x-text="stats(seq.val).raw"></p>
                  <p class="text-[10px] text-slate-400 mt-0.5">chars (with gaps)</p>
                </div>
                <div class="bg-slate-50 border border-slate-200 rounded-lg p-3 text-center">
                  <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Codons</p>
                  <p class="text-2xl font-black text-slate-600 font-mono" x-text="stats(seq.val).codons"></p>
                  <p class="text-[10px] text-slate-400 mt-0.5">complete triplets</p>
                </div>
                <div class="bg-slate-50 border border-slate-200 rounded-lg p-3 text-center">
                  <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">GC Content</p>
                  <p class="text-2xl font-black text-slate-600 font-mono" x-text="stats(seq.val).gc + '%'"></p>
                  <p class="text-[10px] text-slate-400 mt-0.5">of A/T/G/C bases</p>
                </div>
              </div>

              <!-- Nucleotide breakdown -->
              <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Nucleotide Breakdown</p>
                <div class="flex flex-wrap gap-3">
                  <!-- A -->
                  <div class="flex items-center gap-2">
                    <span class="w-6 h-6 rounded bg-emerald-500 text-white text-xs font-black flex items-center justify-center">A</span>
                    <span class="font-mono text-sm font-bold text-slate-700" x-text="stats(seq.val).a"></span>
                    <span class="text-[10px] text-slate-400 font-mono"
                      x-text="stats(seq.val).clean > 0 ? '(' + ((stats(seq.val).a / stats(seq.val).clean) * 100).toFixed(1) + '%)' : ''">
                    </span>
                  </div>
                  <!-- T -->
                  <div class="flex items-center gap-2">
                    <span class="w-6 h-6 rounded bg-sky-500 text-white text-xs font-black flex items-center justify-center">T</span>
                    <span class="font-mono text-sm font-bold text-slate-700" x-text="stats(seq.val).t"></span>
                    <span class="text-[10px] text-slate-400 font-mono"
                      x-text="stats(seq.val).clean > 0 ? '(' + ((stats(seq.val).t / stats(seq.val).clean) * 100).toFixed(1) + '%)' : ''">
                    </span>
                  </div>
                  <!-- C -->
                  <div class="flex items-center gap-2">
                    <span class="w-6 h-6 rounded bg-violet-500 text-white text-xs font-black flex items-center justify-center">C</span>
                    <span class="font-mono text-sm font-bold text-slate-700" x-text="stats(seq.val).c"></span>
                    <span class="text-[10px] text-slate-400 font-mono"
                      x-text="stats(seq.val).clean > 0 ? '(' + ((stats(seq.val).c / stats(seq.val).clean) * 100).toFixed(1) + '%)' : ''">
                    </span>
                  </div>
                  <!-- G -->
                  <div class="flex items-center gap-2">
                    <span class="w-6 h-6 rounded bg-amber-500 text-white text-xs font-black flex items-center justify-center">G</span>
                    <span class="font-mono text-sm font-bold text-slate-700" x-text="stats(seq.val).g"></span>
                    <span class="text-[10px] text-slate-400 font-mono"
                      x-text="stats(seq.val).clean > 0 ? '(' + ((stats(seq.val).g / stats(seq.val).clean) * 100).toFixed(1) + '%)' : ''">
                    </span>
                  </div>
                  <!-- N -->
                  <template x-if="stats(seq.val).n > 0">
                    <div class="flex items-center gap-2">
                      <span class="w-6 h-6 rounded bg-slate-400 text-white text-xs font-black flex items-center justify-center">N</span>
                      <span class="font-mono text-sm font-bold text-slate-500" x-text="stats(seq.val).n"></span>
                      <span class="text-[10px] text-slate-400 font-mono">(ambiguous)</span>
                    </div>
                  </template>
                  <!-- Other -->
                  <template x-if="stats(seq.val).other > 0">
                    <div class="flex items-center gap-2">
                      <span class="w-6 h-6 rounded bg-red-300 text-white text-xs font-black flex items-center justify-center">?</span>
                      <span class="font-mono text-sm font-bold text-red-400" x-text="stats(seq.val).other"></span>
                      <span class="text-[10px] text-slate-400 font-mono">(unrecognised)</span>
                    </div>
                  </template>
                </div>
              </div>

              <!-- GC Content Bias -->
              <template x-if="stats(seq.val).gcBias">
                <div class="rounded-lg border p-4" :class="stats(seq.val).gcBias.color">
                  <div class="flex items-start gap-3">
                    <i class="fa-solid fa-flask mt-0.5 shrink-0 opacity-60"></i>
                    <div>
                      <div class="flex items-center gap-2 mb-1 flex-wrap">
                        <p class="text-[10px] font-bold uppercase tracking-widest opacity-60">GC Content Assessment</p>
                        <span class="text-[10px] font-black uppercase tracking-wider px-2 py-0.5 rounded-full bg-white bg-opacity-60"
                          x-text="stats(seq.val).gcBias.label"></span>
                      </div>
                      <p class="text-xs font-medium" x-text="stats(seq.val).gcBias.note"></p>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </template>

          <!-- Empty state hint -->
          <template x-if="!seq.val.trim()">
            <div class="text-center py-4 text-slate-300 text-xs font-mono">
              <i class="fa-solid fa-keyboard mr-1"></i>Start typing to see stats…
            </div>
          </template>

        </div>
      </template>
    </div>

    <!-- Add strand button -->
    <div class="mt-4">
      <button @click="addSeq()"
        class="bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 px-5 py-2.5 rounded-lg text-sm font-semibold transition-all flex items-center gap-2 shadow-sm">
        <i class="fa-solid fa-plus text-xs"></i>Add Strand
      </button>
    </div>

  </div><!-- /counter -->

</main>

<script>
  const PANELS = ['align','translate','compare','counter'];
  function showTab(name) {
    PANELS.forEach(id => {
      const panel = document.getElementById('panel-'+id);
      const tab   = document.getElementById('tab-'+id);
      if (id === name) {
        panel.classList.remove('hidden');
        tab.classList.remove('tab-inactive');
        tab.classList.add('tab-active');
      } else {
        panel.classList.add('hidden');
        tab.classList.remove('tab-active');
        tab.classList.add('tab-inactive');
      }
    });
  }
</script>
</body>
</html>